<!--
  ~ GPLv3 License
  ~
  ~ Copyright (c) 2022-2026 4ra1n (Jar Analyzer Team)
  ~
  ~ This project is distributed under the GPLv3 license.
  ~
  ~ https://github.com/jar-analyzer/jar-analyzer/blob/master/LICENSE
  -->

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jar Analyzer MCP Report</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/theme-chalk/dark/css-vars.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- ECharts -->
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/atom-one-dark.min.css">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/java.min.js"></script>
    
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #242424;
            --text-color: #e5eaf3;
        }
        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .el-header {
            background-color: #000;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #409eff, #a0cfff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .el-main {
            padding: 20px;
            background-color: var(--bg-color);
        }
        .stat-card {
            background-color: var(--card-bg);
            border: 1px solid #333;
            color: white;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            height: 300px;
            width: 100%;
        }
        .report-card {
            background-color: var(--card-bg);
            border: 1px solid #333;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-color: #409eff;
        }
        .report-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255,255,255,0.02);
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .report-body {
            padding: 20px;
        }
        .score-badge {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .score-high { color: #f56c6c; background: rgba(245, 108, 108, 0.1); }
        .score-med { color: #e6a23c; background: rgba(230, 162, 60, 0.1); }
        .score-low { color: #67c23a; background: rgba(103, 194, 58, 0.1); }
        
        .trace-item {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            padding: 5px 0;
            border-left: 2px solid #409eff;
            padding-left: 10px;
            margin-left: 5px;
            color: #a0cfff;
        }
        .trace-class { 
            color: #409eff; 
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 4px;
        }
        .trace-class:hover {
            color: #79bbff;
        }
        .trace-method { color: #e5eaf3; font-weight: bold; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.5s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        .code-viewer pre {
            margin: 0;
            padding: 10px;
            border-radius: 4px;
            background-color: #282c34;
            overflow: auto;
            max-height: 70vh;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <el-header>
                <div class="logo">
                    <el-icon><Monitor /></el-icon>
                    Jar Analyzer MCP
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <el-button circle @click="openSettings">
                        <el-icon><Setting /></el-icon>
                    </el-button>
                    <el-tag :type="connectionStatus === 'connected' ? 'success' : 'danger'" effect="dark">
                        {{ connectionStatus === 'connected' ? 'Connected' : 'Disconnected' }}
                    </el-tag>
                    <el-button circle @click="toggleTheme">
                        <el-icon><Moon v-if="isDark" /><Sunny v-else /></el-icon>
                    </el-button>
                </div>
            </el-header>
            
            <el-main>
                <el-row :gutter="20">
                    <!-- Stats Cards -->
                    <el-col :span="6">
                        <el-card class="stat-card" shadow="hover">
                            <template #header>
                                <div class="card-header">
                                    <span>Total Reports</span>
                                </div>
                            </template>
                            <h2 style="margin: 0; font-size: 2.5rem; color: #409eff;">{{ reports.length }}</h2>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card class="stat-card" shadow="hover">
                            <template #header><span>High Risk</span></template>
                            <h2 style="margin: 0; font-size: 2.5rem; color: #f56c6c;">{{ highRiskCount }}</h2>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card class="stat-card" shadow="hover">
                            <template #header><span>Medium Risk</span></template>
                            <h2 style="margin: 0; font-size: 2.5rem; color: #e6a23c;">{{ medRiskCount }}</h2>
                        </el-card>
                    </el-col>
                    <el-col :span="6">
                        <el-card class="stat-card" shadow="hover">
                            <template #header><span>Low Risk</span></template>
                            <h2 style="margin: 0; font-size: 2.5rem; color: #67c23a;">{{ lowRiskCount }}</h2>
                        </el-card>
                    </el-col>
                </el-row>

                <el-row :gutter="20" style="margin-top: 20px;">
                    <!-- Charts -->
                    <el-col :span="12">
                        <el-card class="stat-card">
                            <div ref="pieChart" class="chart-container"></div>
                        </el-card>
                    </el-col>
                    <el-col :span="12">
                        <el-card class="stat-card">
                            <div ref="barChart" class="chart-container"></div>
                        </el-card>
                    </el-col>
                </el-row>

                <el-divider content-position="left">Detailed Reports</el-divider>

                <!-- Reports List -->
                <transition-group name="fade">
                    <div v-for="(report, index) in reports" :key="index" class="report-card">
                        <div class="report-header" @click="toggleExpand(index)">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span :class="['score-badge', getScoreClass(report.score)]">{{ report.score }}</span>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.1rem;">{{ formatType(report.type) }}</div>
                                    <div style="color: #888; font-size: 0.9rem;">{{ report.reason }}</div>
                                </div>
                            </div>
                            <el-icon :style="{ transform: expandedIndices.includes(index) ? 'rotate(180deg)' : '' }">
                                <Arrow-Down />
                            </el-icon>
                        </div>
                        <div v-show="expandedIndices.includes(index)" class="report-body">
                            <h4>Stack Trace</h4>
                            <el-timeline>
                                <el-timeline-item
                                    v-for="(trace, tIndex) in report.trace"
                                    :key="tIndex"
                                    :type="tIndex === 0 ? 'primary' : ''"
                                    :hollow="tIndex !== 0"
                                >
                                    <div class="trace-item">
                                        <span class="trace-class" @click="viewCode(trace)">{{ trace.class }}</span>
                                        <span style="color: #666;">.</span>
                                        <span class="trace-method">{{ trace.method }}</span>
                                    </div>
                                </el-timeline-item>
                            </el-timeline>
                        </div>
                    </div>
                </transition-group>
                
                <el-empty v-if="reports.length === 0" description="No reports found" />
            </el-main>

            <!-- Settings Modal -->
            <el-dialog v-model="settingsVisible" title="Settings" width="500px">
                <el-form :model="settings" label-width="120px">
                    <el-form-item label="API Address">
                        <el-input v-model="settings.apiUrl" placeholder="http://127.0.0.1:10032"></el-input>
                    </el-form-item>
                    <el-form-item label="Decompiler">
                        <el-select v-model="settings.decompiler" placeholder="Select decompiler">
                            <el-option label="Fernflower" value="fernflower"></el-option>
                            <el-option label="CFR" value="cfr"></el-option>
                        </el-select>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="settingsVisible = false">Cancel</el-button>
                        <el-button type="primary" @click="saveSettings">Save</el-button>
                    </span>
                </template>
            </el-dialog>

            <!-- Code Viewer Modal -->
            <el-dialog v-model="codeViewerVisible" :title="currentClass + ' - ' + currentMethod" width="80%" top="5vh">
                <div v-loading="loadingCode" class="code-viewer">
                    <pre><code class="language-java" ref="codeBlock">{{ currentCode }}</code></pre>
                </div>
            </el-dialog>
        </el-container>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const { Monitor, Moon, Sunny, ArrowDown, Setting } = ElementPlusIconsVue;

        const app = createApp({
            setup() {
                const reports = ref([]);
                const connectionStatus = ref('disconnected');
                const isDark = ref(true);
                const expandedIndices = ref([]);
                const pieChart = ref(null);
                const barChart = ref(null);
                const settingsVisible = ref(false);
                const codeViewerVisible = ref(false);
                const loadingCode = ref(false);
                const currentCode = ref('');
                const currentClass = ref('');
                const currentMethod = ref('');
                const codeBlock = ref(null);
                
                const settings = ref({
                    apiUrl: localStorage.getItem('ja_api_url') || 'http://127.0.0.1:10032',
                    decompiler: localStorage.getItem('ja_decompiler') || 'fernflower'
                });

                let ws = null;
                let myPieChart = null;
                let myBarChart = null;

                const highRiskCount = computed(() => reports.value.filter(r => r.score >= 7).length);
                const medRiskCount = computed(() => reports.value.filter(r => r.score >= 4 && r.score < 7).length);
                const lowRiskCount = computed(() => reports.value.filter(r => r.score < 4).length);

                const getScoreClass = (score) => {
                    if (score >= 7) return 'score-high';
                    if (score >= 4) return 'score-med';
                    return 'score-low';
                };

                const formatType = (type) => {
                    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                };

                const toggleExpand = (index) => {
                    if (expandedIndices.value.includes(index)) {
                        expandedIndices.value = expandedIndices.value.filter(i => i !== index);
                    } else {
                        expandedIndices.value.push(index);
                    }
                };

                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    document.documentElement.className = isDark.value ? 'dark' : '';
                    initCharts();
                };

                const openSettings = () => {
                    settingsVisible.value = true;
                };

                const saveSettings = () => {
                    localStorage.setItem('ja_api_url', settings.value.apiUrl);
                    localStorage.setItem('ja_decompiler', settings.value.decompiler);
                    settingsVisible.value = false;
                    ElementPlus.ElMessage.success('Settings saved');
                };

                const viewCode = async (trace) => {
                    currentClass.value = trace.class;
                    currentMethod.value = trace.method;
                    currentCode.value = '';
                    codeViewerVisible.value = true;
                    loadingCode.value = true;

                    try {
                        const baseUrl = settings.value.apiUrl.replace(/\/$/, '');
                        const decompiler = settings.value.decompiler;
                        const targetUrl = `${baseUrl}/api/${decompiler}_code?class=${encodeURIComponent(trace.class)}&method=${encodeURIComponent(trace.method)}&desc=${encodeURIComponent(trace.desc || '')}`;
                        
                        // Use proxy endpoint
                        const response = await axios.get('/api/proxy', {
                            params: { url: targetUrl }
                        });

                        if (response.data.success === false) {
                            currentCode.value = `// Error: ${response.data.message}`;
                        } else {
                            currentCode.value = response.data.methodCode || response.data.fullClassCode || '// No code found';
                        }
                    } catch (error) {
                        console.error('Failed to fetch code:', error);
                        currentCode.value = `// Failed to fetch code: ${error.message}\n// Please check API URL settings and ensure Jar Analyzer is running.`;
                    } finally {
                        loadingCode.value = false;
                        nextTick(() => {
                            if (codeBlock.value) {
                                hljs.highlightElement(codeBlock.value);
                            }
                        });
                    }
                };

                const fetchHistory = async () => {
                    try {
                        const response = await axios.get('/api/history');
                        if (response.data) {
                            reports.value = response.data;
                            updateCharts();
                        }
                    } catch (error) {
                        console.error('Failed to fetch history:', error);
                        ElementPlus.ElMessage.error('Failed to load history data');
                    }
                };

                const connectWebSocket = () => {
                    const wsUrl = 'ws://__JAR_ANALYZER_REPORT_MCP__/ws';
                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        connectionStatus.value = 'connected';
                        ElementPlus.ElMessage.success('Connected to MCP Server');
                    };

                    ws.onmessage = (event) => {
                        try {
                            const newData = JSON.parse(event.data);
                            reports.value.unshift(newData);
                            updateCharts();
                            ElementPlus.ElNotification({
                                title: 'New Vulnerability Detected',
                                message: `${formatType(newData.type)} (Score: ${newData.score})`,
                                type: newData.score >= 7 ? 'error' : 'warning',
                            });
                        } catch (error) {
                            console.error('WebSocket message error:', error);
                        }
                    };

                    ws.onclose = () => {
                        connectionStatus.value = 'disconnected';
                        setTimeout(connectWebSocket, 3000);
                    };
                };

                const initCharts = () => {
                    if (myPieChart) myPieChart.dispose();
                    if (myBarChart) myBarChart.dispose();

                    const theme = isDark.value ? 'dark' : 'light';
                    const bg = isDark.value ? '#242424' : '#fff';

                    myPieChart = echarts.init(pieChart.value, theme);
                    myBarChart = echarts.init(barChart.value, theme);
                    
                    updateCharts();
                };

                const updateCharts = () => {
                    if (!myPieChart || !myBarChart) return;

                    const typeCount = {};
                    reports.value.forEach(r => {
                        typeCount[r.type] = (typeCount[r.type] || 0) + 1;
                    });
                    const pieData = Object.keys(typeCount).map(k => ({ value: typeCount[k], name: formatType(k) }));

                    myPieChart.setOption({
                        title: { text: 'Vulnerability Types', left: 'center' },
                        tooltip: { trigger: 'item' },
                        legend: { bottom: '0%' },
                        backgroundColor: 'transparent',
                        series: [{
                            name: 'Types',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            data: pieData,
                            itemStyle: { borderRadius: 10, borderColor: '#242424', borderWidth: 2 }
                        }]
                    });

                    const scoreDist = Array(11).fill(0);
                    reports.value.forEach(r => {
                        if (r.score >= 0 && r.score <= 10) scoreDist[r.score]++;
                    });

                    myBarChart.setOption({
                        title: { text: 'Score Distribution', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: Array.from({length: 11}, (_, i) => i) },
                        yAxis: { type: 'value' },
                        backgroundColor: 'transparent',
                        series: [{
                            data: scoreDist,
                            type: 'bar',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#409eff' },
                                    { offset: 1, color: '#104b88' }
                                ])
                            }
                        }]
                    });
                };

                onMounted(() => {
                    fetchHistory();
                    connectWebSocket();
                    nextTick(() => {
                        initCharts();
                        window.addEventListener('resize', () => {
                            myPieChart && myPieChart.resize();
                            myBarChart && myBarChart.resize();
                        });
                    });
                });

                return {
                    reports,
                    connectionStatus,
                    isDark,
                    expandedIndices,
                    pieChart,
                    barChart,
                    highRiskCount,
                    medRiskCount,
                    lowRiskCount,
                    settingsVisible,
                    settings,
                    codeViewerVisible,
                    loadingCode,
                    currentCode,
                    currentClass,
                    currentMethod,
                    codeBlock,
                    getScoreClass,
                    formatType,
                    toggleExpand,
                    toggleTheme,
                    openSettings,
                    saveSettings,
                    viewCode
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }
        app.mount('#app');
    </script>
</body>
</html>
